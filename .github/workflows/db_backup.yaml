---
name: DB Backup
on:
  schedule:
    - cron: "0 9 * * *" # Runs at 09:00 UTC (05:00 EDT) daily
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
jobs:
  db_backup:
    name: DB backup
    runs-on: ubuntu-latest
    env:
      DB_HOST: mysql.samarchyan.me
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - uses: szenius/set-timezone@v1.0
        with:
          timezoneLinux: "America/New_York"

      - name: Backup DB
        run: make backup-db
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: Install s3cmd
        run: |
          pip install s3cmd==2.2.0
          cp .github/workflows/.s3cfg ~/.s3cfg
          sed "s/\[access_key\]/${{ secrets.SPACES_ACCESS_KEY }}/g" ~/.s3cfg -i
          SPACES_SECRET_KEY=$(echo ${{ secrets.SPACES_SECRET_KEY }} | sed 's;/;\\/;g')
          sed "s/\[secret_key\]/$SPACES_SECRET_KEY/g" ~/.s3cfg -i

      - name: Upload backup
        run: make upload-backup
