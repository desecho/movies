---
name: DB Backup
on:
  schedule:
    - cron: "0 0 * * *"  # Every Day at Midnight
  workflow_dispatch:

jobs:
  db_backup:
    name: DB backup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Backup DB
        run: make backup-db
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

      - name: Install s3cmd
        run: |
          pip install s3cmd==2.2.0
          cp .github/workflows/.s3cfg ~/.s3cfg
          sed "s/\[access_key\]/${{ secrets.SPACES_ACCESS_KEY }}/g" ~/.s3cfg -i
          SPACES_SECRET_KEY=$(echo ${{ secrets.SPACES_SECRET_KEY }} | sed 's;/;\\/;g')
          sed "s/\[secret_key\]/$SPACES_SECRET_KEY/g" ~/.s3cfg -i

      - name: Upload backup
        run: |
          NOW=$(date +"%d-%m-%Y")
          DB_NAME=githubcontrib
          DB_NAME=movies
          ARCHIVE=${DB_NAME}-${NOW}.sql.gz
          s3cmd put ${ARCHIVE} s3://scrap-db-backups/${DB_NAME}/ --acl-private --no-mime-magic --guess-mime-type
